services:
  thewallflower:
    image: ghcr.io/jellman86/thewallflower:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: thewallflower
    ports:
      - "${PORT:-8953}:8953"           # Main API
      - "${GO2RTC_PORT:-8954}:8954"    # go2rtc HTTP API & WebUI
      - "${GO2RTC_RTSP_PORT:-8955}:8955"   # go2rtc RTSP server
      - "${GO2RTC_WEBRTC_PORT:-8956}:8956" # go2rtc WebRTC
    volumes:
      - ${CONFIG_PATH}/thewallflower/data:/data
    environment:
      - DATABASE_URL=sqlite:////data/thewallflower.db
      - WHISPER_HOST=whisper-live
      - WHISPER_PORT=9090
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - WORKERS=${WORKERS:-1}
      - WAIT_FOR_WHISPER=true
      # go2rtc configuration
      - GO2RTC_HOST=${GO2RTC_HOST:-localhost}
      - GO2RTC_PORT=8954
      - GO2RTC_RTSP_PORT=8955
      - GO2RTC_WEBRTC_PORT=8956
      
      # WebRTC Configuration (Critical for Bridge Mode/TrueNAS)
      # The IP address of your TrueNAS server (e.g., 192.168.1.50)
      # DNS names are allowed but raw IP is recommended for LAN reliability.
      - WEBRTC_ADVERTISED_IP=${WEBRTC_ADVERTISED_IP}
      
      # The port mapped to 8956 (default: 8956)
      - WEBRTC_ADVERTISED_PORT=${WEBRTC_ADVERTISED_PORT:-8956}

    depends_on:
      - whisper-live
    restart: unless-stopped
    networks:
      - default

  whisper-live:
    # Image selection - set WHISPER_IMAGE in .env:
    #   CPU only:    ghcr.io/collabora/whisperlive-cpu:latest
    #   NVIDIA GPU:  ghcr.io/collabora/whisperlive-gpu:latest
    #   Intel GPU:   ghcr.io/collabora/whisperlive-openvino:latest
    image: ${WHISPER_IMAGE:-ghcr.io/collabora/whisperlive-cpu:latest}
    container_name: whisper-live
    ports:
      - "${WHISPER_PORT:-8957}:9090"
    environment:
      - WHISPER_MODEL=${WHISPER_MODEL:-base.en}
    restart: unless-stopped
    networks:
      - default
    #
    # ============ GPU ACCELERATION (uncomment ONE section) ============
    #
    # Intel GPU support - uncomment for Intel iGPU/Arc acceleration
    # Also set WHISPER_IMAGE=ghcr.io/collabora/whisperlive-openvino:latest
    devices:
    - /dev/dri:/dev/dri
    group_add:
      - "44"    # video group GID (use number to avoid group name issues)
    #   - "109"   # render group GID (may vary - check with: getent group render)
    #
    # NVIDIA GPU support - uncomment for NVIDIA CUDA acceleration
    # Also set WHISPER_IMAGE=ghcr.io/collabora/whisperlive-gpu:latest
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

networks:
  default:
    name: ${NETWORK_NAME:-thewallflower-network}
    external: ${NETWORK_EXTERNAL:-false}
